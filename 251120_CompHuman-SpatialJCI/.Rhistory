setwd("~/PROJECTS/DPN_DREX_HumanSpatial/251120_CompHuman-SpatialJCI")
if (requireNamespace("rstudioapi", quietly = TRUE) && rstudioapi::isAvailable()) {
script_path <- rstudioapi::getActiveDocumentContext()$path
setwd(dirname(script_path))
}
options(repos = c(CRAN = "https://cloud.r-project.org"))
if (!requireNamespace("pacman", quietly = TRUE)) install.packages("pacman")
pacman::p_load(
dplyr, tidyr, tibble, purrr, stringr, readxl,
openxlsx, homologene
)
# Install STRINGdb if needed
if (!requireNamespace("STRINGdb", quietly = TRUE)) {
if (!requireNamespace("BiocManager", quietly = TRUE)) install.packages("BiocManager")
BiocManager::install("STRINGdb", ask = FALSE)
}
library(STRINGdb)
################################################################################
# Settings
################################################################################
schwann_deg_path <- "./DEGs_JCI_DPN/SchwannDEG_Severe-Moderate_noMito.csv"
mouse_deg_dirs <- c("../DEG_Major", "temp_aggSC")
output_root <- "Output_JCI/PPI_Network_Analysis"
dir.create(output_root, showWarnings = FALSE, recursive = TRUE)
# Focus on specific cell types
mouse_cell_types <- c("majorSC", "aggSC")
comparison_groups <- c("HFDvsSD", "DRvsHFD", "EXvsHFD", "DREXvsHFD")
# STRING settings
mouse_species <- 10090  # Mus musculus
human_species <- 9606   # Homo sapiens
score_threshold <- 400  # Medium confidence (0-1000 scale)
network_limit <- 200    # Max genes for network visualization
# P-value thresholds
pval_mouse_cutoff <- 0.01
padj_human_cutoff <- 0.001
lfc_human_cutoff <- 1
################################################################################
# Helper functions
################################################################################
read_csv_utf8 <- function(path) {
suppressWarnings(utils::read.csv(path, stringsAsFactors = FALSE, check.names = FALSE, fileEncoding = "UTF-8"))
}
safe_base <- function(x, limit = 150) {
x <- gsub("[^A-Za-z0-9._-]+", "_", x)
if (nchar(x) > limit) substr(x, 1, limit) else x
}
save_df <- function(df, path) {
dir.create(dirname(path), showWarnings = FALSE, recursive = TRUE)
utils::write.csv(df, path, row.names = FALSE)
}
build_human_to_mouse_map <- function() {
hom <- homologene::homologeneData
human <- hom %>%
dplyr::filter(Taxonomy == 9606) %>%
dplyr::select(HID, Human_Symbol = Gene.Symbol)
mouse <- hom %>%
dplyr::filter(Taxonomy == 10090) %>%
dplyr::select(HID, Mouse_Symbol = Gene.Symbol)
dplyr::left_join(human, mouse, by = "HID") %>%
dplyr::filter(!is.na(Mouse_Symbol)) %>%
dplyr::arrange(Human_Symbol) %>%
dplyr::group_by(Human_Symbol) %>%
dplyr::slice(1) %>%
dplyr::ungroup() %>%
dplyr::select(Human_Symbol, Mouse_Symbol)
}
read_schwann_deg <- function(file_path, lfc_cutoff = 1, padj_cutoff = 0.001) {
df <- suppressWarnings(read_csv_utf8(file_path))
if (!"Gene" %in% colnames(df)) colnames(df)[1] <- "Gene"
cn <- tolower(gsub("\\s+", "_", colnames(df)))
colnames(df) <- cn
gene_col <- "gene"
lfc_col  <- if ("avg_log2fc" %in% cn) "avg_log2fc" else if ("log2foldchange" %in% cn) "log2foldchange" else stop("Cannot find log2FC in Schwann DEG file.")
padj_col <- if ("p_val_adj" %in% cn) "p_val_adj" else if ("padj" %in% cn) "padj" else stop("Cannot find padj in Schwann DEG file.")
df %>%
dplyr::filter(!is.na(.data[[gene_col]]), .data[[gene_col]] != "") %>%
dplyr::filter(abs(.data[[lfc_col]]) > lfc_cutoff, .data[[padj_col]] < padj_cutoff) %>%
dplyr::distinct(.data[[gene_col]]) %>%
dplyr::pull()
}
read_mouse_deg_file <- function(file_path, pval_cutoff = 0.01, return_full = FALSE) {
df <- suppressWarnings(read_csv_utf8(file_path))
if (is.na(colnames(df)[1]) || colnames(df)[1] == "" || colnames(df)[1] %in% c("X", "...1")) {
colnames(df)[1] <- "Gene"
} else {
colnames(df)[1] <- "Gene"
}
cn <- tolower(gsub("\\s+", "_", colnames(df)))
colnames(df) <- cn
pval_col <- "p_val"
lfc_col  <- if ("avg_log2fc" %in% cn) "avg_log2fc" else if ("log2foldchange" %in% cn) "log2foldchange" else NULL
if (!pval_col %in% cn || is.null(lfc_col)) return(NULL)
df_filtered <- df %>%
dplyr::filter(!is.na(gene), gene != "") %>%
dplyr::filter(.data[[pval_col]] < pval_cutoff)
if (return_full) {
df_filtered %>%
dplyr::transmute(gene = gene, log2FC = .data[[lfc_col]], pval = .data[[pval_col]])
} else {
df_filtered %>% dplyr::distinct(gene) %>% dplyr::pull()
}
}
# Robust handling of ppi_enrichment output
.scalar_chr <- function(x) {
if (is.null(x) || length(x) == 0) return(NA_character_)
as.character(x[[1]])
}
.normalize_ppi <- function(ppi_enrich) {
if (is.null(ppi_enrich)) return(list())
# Some versions use expected_number_of_edges instead of number_of_expected_edges
if (is.null(ppi_enrich$number_of_expected_edges) && !is.null(ppi_enrich$expected_number_of_edges)) {
ppi_enrich$number_of_expected_edges <- ppi_enrich$expected_number_of_edges
}
ppi_enrich
}
.ppi_to_df <- function(ppi_enrich) {
ppi_enrich <- .normalize_ppi(ppi_enrich)
tibble::tibble(
metric = c("p_value", "number_of_edges", "number_of_expected_edges",
"average_node_degree", "local_clustering_coefficient"),
value  = c(
.scalar_chr(ppi_enrich[["p_value"]]),
.scalar_chr(ppi_enrich[["number_of_edges"]]),
.scalar_chr(ppi_enrich[["number_of_expected_edges"]]),
.scalar_chr(ppi_enrich[["average_node_degree"]]),
.scalar_chr(ppi_enrich[["local_clustering_coefficient"]])
)
) %>% dplyr::filter(!is.na(value))
}
.get_exp_edges <- function(ppi_enrich) {
ppi_enrich <- .normalize_ppi(ppi_enrich)
if (!is.null(ppi_enrich$number_of_expected_edges)) return(ppi_enrich$number_of_expected_edges)
NA_real_
}
################################################################################
# Initialize STRING databases
################################################################################
message("=== Initializing STRING databases ===")
string_mouse <- STRINGdb$new(version = "12.0", species = mouse_species,
score_threshold = score_threshold, input_directory = "")
string_human <- STRINGdb$new(version = "12.0", species = human_species,
score_threshold = score_threshold, input_directory = "")
################################################################################
# Load human JCI_SC DEGs
################################################################################
message("\n=== Loading Human JCI_SC DEGs ===")
human2mouse <- build_human_to_mouse_map()
schwann_genes <- read_schwann_deg(schwann_deg_path,
lfc_cutoff = lfc_human_cutoff,
padj_cutoff = padj_human_cutoff)
message("Human JCI_SC DEGs: ", length(schwann_genes), " genes")
# Map human genes to STRING IDs
schwann_df <- data.frame(gene = schwann_genes, stringsAsFactors = FALSE)
schwann_mapped <- string_human$map(schwann_df, "gene", removeUnmappedRows = TRUE)
