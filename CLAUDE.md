# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This repository contains R scripts for analyzing diabetic peripheral neuropathy (DPN) using mouse peripheral nerve scRNA-seq data compared against human spatial transcriptomics and bulk RNA-seq datasets. The primary focus is on Schwann cell populations and their differential gene expression across diet/exercise interventions (SD, HFD, DR, DREX, EX).

## Key Datasets

### Mouse scRNA-seq DEG Files
- **DEG/**: Fine-grained cell type DEG files (mySC, nmSC, ImmSC, SC3, Endo, Mac, Pericytes, etc.)
- **DEG_Major/**: Major cell type DEG files (majorSC, majorEndo, majorFib, majorMac, etc.)
- **DEGs_aggSC/**: Aggregated Schwann cell files (mySC + nmSC + ImmSC, generated by Script 00)
- Files follow naming convention: `{comparison}_{celltype}.csv` (e.g., `DREXvsDR_mySC.csv`)

### Human Reference Datasets
- **DEGs_HSuralRNASeq_Human/**: Human sural nerve spatial transcriptomics DEG table
- **DEGs_JCI_DPN/SchwannDEG_Severe-Moderate_noMito.csv**: Human Schwann cell DEGs
- **DEGs_JCI_DPN/JCI184075.sdd3_BulkRNAseqDEGs.xlsx**: Human bulk RNA-seq DEGs from JCI paper

### Schwann Cell Types
When filtering for Schwann cells, include these cell types:
- `mySC` (myelinating Schwann cells)
- `nmSC` (non-myelinating Schwann cells)
- `ImmSC` (immature Schwann cells)
- `SC3` (Schwann cell subtype 3)
- `majorSC` (major Schwann cell category in DEG_Major/)
- `aggSC` (aggregated Schwann cells: mySC + nmSC + ImmSC combined)

## Analysis Pipeline (251120_CompHuman-SpatialJCI/)

The analysis pipeline consists of **10 sequential scripts (00-09)** that must be run in order.

### Script 00: Primary Enrichment Analysis (REQUIRED FIRST)
**File**: `00_enrichment_JCI_Schwann_mouse.R`
**Output**: `Output_JCI/00_DEGoverlap_Enrichment_Analysis/`

**Purpose**:
- Creates aggSC files by aggregating mySC, nmSC, ImmSC (keeps most significant gene per duplicate)
- Maps human DEGs to mouse orthologs using homologene
- Compares mouse scRNA-seq DEGs against human Schwann and JCI bulk datasets
- Calculates overlap gene sets (Mouse∩Schwann, Mouse∩JCI, Schwann∩JCI, all three)
- Performs GO/KEGG enrichment analysis on overlap sets using richR
- Generates master summary workbook

**Key Parameters**:
```r
padj_extra_cutoff <- 0.001   # For Schwann/JCI datasets (human)
lfc_extra_cutoff  <- 1       # For Schwann/JCI datasets (human)
padj_cutoff <- 0.01          # For mouse DEGs (raw p-value, not adjusted)
min_genes_for_enrichment <- 5
```

**Run Command**:
```bash
cd 251120_CompHuman-SpatialJCI && Rscript 00_enrichment_JCI_Schwann_mouse.R
```

### Scripts 01-08: Downstream Analyses (Run after Script 00)
These scripts depend on outputs from Script 00 and can be run in any order:

- **01_celltype_enrichment_comparison.R**: Cell type-specific pathway comparison
- **02_intervention_response.R**: Intervention-specific effects analysis
- **03_conservation_analysis.R**: Cross-species conservation scoring
- **04_direction_of_change.R**: Concordance/discordance analysis
- **05_leading_edge_genes.R**: Hub gene identification
- **06_bioenergetic_focus.R**: Metabolic pathway focus
- **07_ppi_network_analysis.R**: STRING PPI network analysis
- **08_pathway_overlap_heatmaps.R**: Pathway conservation heatmaps

### Script 09: Overlap Significance Analysis
**File**: `09_overlap_significance_analysis.R`
**Output**: `Output_JCI/09_Overlap_Significance/`

**Purpose**:
- Statistical validation of Mouse∩Schwann gene overlaps
- Uses hypergeometric distribution with 20,000 gene background (full mouse genome)
- Calculates Z-scores, p-values, and enrichment fold changes
- Generates significance visualizations and summary tables

**Key Parameters**:
```r
background_size <- 20000     # Full mouse genome
n_perm <- 10000              # Permutations (when using permutation test)
```

**Run Command**:
```bash
cd 251120_CompHuman-SpatialJCI && Rscript 09_overlap_significance_analysis.R
```

## Output Directory Structure

All analyses output to a unified, numbered directory structure in `Output_JCI/`:

```
Output_JCI/
├── Master_Enrichment_Summary.csv
├── Master_Enrichment_Summary.xlsx
├── 00_DEGoverlap_Enrichment_Analysis/      # Script 00: Enrichment results
│   └── {comparison}_{celltype}_enrichment/
│       ├── Mouse_all_Genes.csv
│       ├── Schwann_all_Genes.csv
│       ├── JCI_all_Genes.csv
│       ├── Overlap_MS_Genes.csv
│       ├── Overlap_MJ_Genes.csv
│       ├── Overlap_SJ_Genes.csv
│       ├── Overlap_All3_Genes.csv
│       ├── Mouse_only_Genes.csv
│       ├── Schwann_only_Genes.csv
│       ├── JCI_only_Genes.csv
│       ├── Venn_Diagram.png
│       ├── {set}_richR_GO.csv
│       ├── {set}_richR_KEGG.csv
│       ├── {set}_clusterProfiler_GO.csv
│       └── {set}_clusterProfiler_KEGG.csv
├── 01_CellType_Comparison/                 # Script 01
├── 02_Intervention_Response/               # Script 02
├── 03_Conservation_Analysis/               # Script 03
├── 04_Direction_Analysis/                  # Script 04
├── 05_Leading_Edge_Analysis/               # Script 05
├── 06_Bioenergetic_Focus/                  # Script 06
├── 07_PPI_Network_Analysis/                # Script 07
├── 08_Pathway_Overlap_Heatmaps/            # Script 08
└── 09_Overlap_Significance/                # Script 09
    ├── Overlap_Significance_Summary.csv
    ├── Zscore_Plot.png
    ├── Pvalue_Plot.png
    ├── Enrichment_Plot.png
    ├── Observed_vs_Expected.png
    └── Comparison_Summary.png
```

## Development Setup

### Required R Packages
Install dependencies using pacman:
```r
if (!requireNamespace("pacman", quietly = TRUE)) install.packages("pacman")
pacman::p_load(
  dplyr, tidyr, ggplot2, ggVennDiagram, readxl, homologene,
  pheatmap, openxlsx, AnnotationDbi, org.Mm.eg.db, org.Hs.eg.db,
  richR, clusterProfiler, STRINGdb, purrr, readr
)
```

### Running Scripts
- **ALWAYS** run Script 00 first to generate enrichment data and aggSC files
- Run scripts from the `251120_CompHuman-SpatialJCI/` directory
- Use `Rscript {script_name}.R` from within the directory
- For interactive sessions: `R -q` then `source("{script_name}.R")`

**Example workflow**:
```bash
cd 251120_CompHuman-SpatialJCI

# Step 1: REQUIRED - Generate enrichment data
Rscript 00_enrichment_JCI_Schwann_mouse.R

# Step 2: Downstream analyses (any order)
Rscript 01_celltype_enrichment_comparison.R
Rscript 02_intervention_response.R
# ... etc

# Step 3: Statistical validation
Rscript 09_overlap_significance_analysis.R
```

## Code Architecture

### Human-to-Mouse Gene Mapping
- Uses `homologene::homologeneData` to map between species
- Function: `build_human_to_mouse_map()` creates Human_Symbol -> Mouse_Symbol lookup table
- Takes first match (lowest Entrez ID) when multiple mouse orthologs exist
- Function: `map_genes_to_mouse(genes, mapping_tbl)` converts gene lists
- Typically ~10-30% of human genes lack clear mouse orthologs

### DEG File Reading Functions
- `read_schwann_deg()`: Reads human Schwann DEGs (abs(log2FC) > 1, padj < 0.001)
- `read_jci_bulk_deg()`: Reads JCI bulk Excel file (abs(log2FC) > 1, padj < 0.001)
- `read_mouse_deg_file()`: Reads mouse scRNA-seq CSVs (p < 0.01, raw p-value)
- All functions normalize column names to lowercase with underscores for robustness
- Handle empty first column names (row names from R exports)

### aggSC File Generation
Script 00 creates aggregated Schwann cell files:
1. Reads DEGs from mySC, nmSC, ImmSC for each comparison
2. Combines all genes across the three cell types
3. When same gene appears in multiple types, keeps entry with **lowest p-value**
4. Writes to `DEGs_aggSC/{comparison}_aggSC.csv`

This provides a comprehensive Schwann cell view capturing genes from all subtypes.

### Enrichment Analysis Workflow
1. **Load datasets**: Human Schwann, JCI bulk, mouse scRNA-seq
2. **Map to mouse orthologs**: Convert human genes to mouse symbols via homologene
3. **For each mouse DEG file** (20 comparisons × cell types):
   - Calculate overlap sets: Mouse∩Schwann, Mouse∩JCI, Schwann∩JCI, all three
   - Calculate unique sets: Mouse-only, Schwann-only, JCI-only
   - Save gene lists as CSV files
   - Run enrichment if ≥ 5 genes in set
4. **Enrichment methods** (in order of preference):
   - `richR::richGO()` and `richR::richKEGG()` (primary, with builtin=FALSE for KEGG)
   - Fallback: `clusterProfiler::enrichGO()` (GO:BP, SYMBOL) and `enrichKEGG()` (KEGG, Entrez)
5. **Output summary**: Master Excel workbook with counts per comparison/cell type

### Statistical Significance Testing (Script 09)
Uses **hypergeometric distribution** for significance testing:
- **Background**: 20,000 mouse genes (full genome)
- **Formula**: Expected = (n₁ × n₂) / N, where n₁=mouse DEGs, n₂=human Schwann genes, N=20,000
- **Z-score**: (Observed - Expected) / SD
- **P-value**: From normal approximation (one-tailed test for enrichment)
- **Enrichment fold**: Observed / Expected

More conservative than using only detected genes (~7,000) as background.

## Coding Conventions

### Style
- **Tidyverse style**: pipe-friendly, snake_case names, 2-space indentation
- **Package loading**: Always use `pacman::p_load()` for auto-installation
- **Column name normalization**: `tolower(gsub("\\s+", "_", colnames(df)))`
- **Error handling**: Use `suppressWarnings()` for expected warnings (e.g., column name changes)

### Helper Functions
- `safe_base(x, limit = 150)`: Sanitizes file names for Windows paths
- `save_df(df, path)`: Writes CSV with automatic directory creation
- `save_plot(p, path, ...)`: Saves ggplot as PNG/PDF
- `sanitize_sheet(x)`: Cleans Excel sheet names (31-char limit, no special chars)

### File Naming
- Use `safe_base()` to sanitize all derived file names
- Limit to 150 characters for Windows compatibility
- Remove special characters except `._-`
- Output directories use numbered prefix (00-09) for sequential organization

## Comparison Groups

Mouse intervention groups being compared:
- **SD**: Standard diet (healthy control)
- **HFD**: High-fat diet (disease model)
- **DR**: Diet restriction (intervention)
- **DREX**: Diet restriction + exercise (combined intervention)
- **EX**: Exercise only (intervention)

Common comparisons in DEG files:
- `HFDvsSD` - Disease baseline
- `DRvsHFD` - Diet restriction intervention
- `EXvsHFD` - Exercise intervention
- `DREXvsHFD` - Combined intervention
- `DREXvsDR` - Additive effect of exercise on DR
- `EXvsDREX` - Difference between EX and combined
- `DRvsSD`, `DRvsEX` - Additional comparisons

## Key Results and Summaries

**Summary Documents** (in `251120_CompHuman-SpatialJCI/`):
- `SUMMARY_MouseSchwann_HFDvsSD.md` - Disease baseline analysis
- `SUMMARY_MouseSchwann_DRvsHFD.md` - Diet restriction effects
- `SUMMARY_MouseSchwann_EXvsHFD.md` - Exercise effects
- `SUMMARY_MouseSchwann_DREXvsHFD.md` - Combined intervention effects
- `MASTER_SUMMARY_MouseSchwann_ALL.md` - Comprehensive cross-comparison
- `SUMMARY_Overlap_Significance_Analysis.md` - Statistical validation results

**Documentation**:
- `ANALYSIS_GUIDE.md` - Detailed description of all 10 analysis scripts
- `CLAUDE.md` (this file) - Quick reference for development

## Important Notes

### Execution Order
1. **MUST run Script 00 first** - generates aggSC files and enrichment data
2. Scripts 01-08 can run in any order after Script 00
3. Script 09 can run anytime after Script 00 (requires DEG files and Schwann data)

### File Paths
- **Archive folders**: Do not modify scripts in `archive/` subdirectories
- **Relative paths**: Scripts assume execution from `251120_CompHuman-SpatialJCI/` directory
- **Output paths**: All use numbered directories (00-09) for organization

### Data Quality
- **Timeouts**: Enrichment can timeout for large gene sets (>500 genes)
- **Missing values**: Human-to-mouse mapping loses ~10-30% of genes without orthologs
- **P-value thresholds**: Mouse uses raw p<0.01, human uses padj<0.001 (more stringent)
- **Reproducibility**: All outputs are deterministic; safe to regenerate from source data

### Statistical Considerations
- **Background size matters**: Script 09 uses 20,000 genes (genome-wide) not ~7,000 (detected)
- **Multiple testing**: Consider FDR correction when interpreting enrichment results
- **Overlap significance**: ALL Schwann cell comparisons are highly significant (p<0.001)
- **Enrichment interpretation**: Values >2x indicate biological significance, >5x very strong

## Recent Changes (December 2025)

1. **Directory reorganization**: Output directories now numbered (00-09)
2. **aggSC directory**: Renamed from `temp_aggSC` to `DEGs_aggSC`
3. **Script 09 added**: Statistical significance testing with hypergeometric distribution
4. **Summary files updated**: All include file paths and updated to December 4, 2025
5. **ANALYSIS_GUIDE.md**: Comprehensive documentation of all 10 scripts

---

*Last Updated: December 4, 2025*
*Analysis Pipeline Version: 2.2*
